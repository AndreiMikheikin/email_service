name: Деплой продакшен окружения с SSR

on:
  push:
    branches: [master]
    paths:
      - 'apps/admin-spa/**'
      - 'apps/client-spa/**'
      - 'src/**'
      - '.github/workflows/deploy.yml'

env:
  NODE_ENV: production
  SSH_HOST: 178.250.247.67
  DEPLOY_DIR: /root/email-service          # Основная директория деплоя
  WEB_ROOT: /var/www/email-service         # Директория веб-сервера

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    # ----------------------------
    # 1. ПОДГОТОВКА РЕПОЗИТОРИЯ
    # ----------------------------
    - name: Загрузка кода
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    # ----------------------------
    # 2. НАСТРОЙКА ОКРУЖЕНИЯ
    # ----------------------------
    - name: Установка Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: |
          apps/admin-spa/package-lock.json
          apps/client-spa/package-lock.json

    # ----------------------------
    # 3. УСТАНОВКА ЗАВИСИМОСТЕЙ
    # ----------------------------
    - name: Установка корневых зависимостей
      run: npm ci --ignore-scripts

    - name: Установка зависимостей admin-spa
      working-directory: apps/admin-spa
      run: |
          npm ci --include=dev  # Устанавливаем и dev-зависимости
          npm list --depth=0

    - name: Установка зависимостей client-spa
      working-directory: apps/client-spa
      run: npm ci

    # ----------------------------
    # 4. СБОРКА ПРОЕКТОВ
    # ----------------------------
    - name: Сборка admin-spa (SSR)
      working-directory: apps/admin-spa
      run: |
        npm run build:client
        npm run build:server
        
        # Проверка критических файлов
        [ -f dist/client/index.html ] || { echo "Отсутствует index.html"; exit 1; }
        [ -f dist/server/entry-server.js ] || { echo "Отсутствует entry-server.js"; exit 1; }

    - name: Сборка client-spa (SPA)
      working-directory: apps/client-spa
      run: |
        npm run build
        [ -f dist/index.html ] || { echo "Отсутствует index.html"; exit 1; }

    # ----------------------------
    # 5. ПОДГОТОВКА АРТЕФАКТОВ
    # ----------------------------
    - name: Упаковка артефактов для деплоя
      run: |
        mkdir -p artifact/{core,admin-spa,client-spa}
        
        # Основной сервис
        cp -r src sql package*.json ecosystem.config.cjs artifact/core/
        
        # Admin SPA
        cp apps/admin-spa/{server.js,package*.json,.env*} artifact/admin-spa/ 2>/dev/null || true
        cp -r apps/admin-spa/dist artifact/admin-spa/
        
        # Client SPA
        cp -r apps/client-spa/dist artifact/client-spa/
        cp apps/client-spa/{package*.json,.env*} artifact/client-spa/ 2>/dev/null || true
        
        tree artifact -L 3  # Проверка структуры

    # ----------------------------
    # 6. НАСТРОЙКА SSH
    # ----------------------------
    - name: Настройка SSH подключения
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

    # ----------------------------
    # 7. ДЕПЛОЙ НА СЕРВЕР
    # ----------------------------
    - name: Деплой основного сервиса
      run: |
        rsync -avz --chmod=600 --delete artifact/core/ root@$SSH_HOST:/root/email-service/
        ssh root@$SSH_HOST "
          cd /root/email-service
          npm ci --production --ignore-scripts
        "

    - name: Деплой admin-spa
      run: |
        rsync -avz --delete artifact/admin-spa/ root@$SSH_HOST:/root/email-service/apps/admin-spa/
        ssh root@$SSH_HOST "
          cd /root/email-service/apps/admin-spa
          npm ci --production
          [ -f .env.production ] && cp .env.production .env || true
        "

    - name: Деплой client-spa
      run: |
        rsync -avz --delete artifact/client-spa/ root@$SSH_HOST:/root/email-service/apps/client-spa/
        ssh root@$SSH_HOST "
          cd /root/email-service/apps/client-spa
          npm ci --production
          [ -f .env.production ] && cp .env.production .env || true
        "

    # ----------------------------
    # 8. НАСТРОЙКА ПРОДКШЕНА
    # ----------------------------
    - name: Настройка продакшен окружения
      run: |
        ssh root@$SSH_HOST "
          # Создание директорий
          mkdir -p /var/www/email-service/admin-spa /var/www/email-service/client-spa
          
          # Копирование файлов
          rsync -a --delete /root/email-service/apps/admin-spa/dist/client/ /var/www/email-service/admin-spa/
          rsync -a --delete /root/email-service/apps/client-spa/dist/ /var/www/email-service/client-spa/
          
          # Настройка прав
          chown -R www-data:www-data /var/www/email-service
          find /var/www/email-service -type d -exec chmod 755 {} \;
          find /var/www/email-service -type f -exec chmod 644 {} \;
          
          # Сжатие статики (если скрипт существует)
          if [ -f /root/email-service/src/jobs/compress-static.js ]; then
            echo 'Выполнение сжатия статических файлов...'
            node /root/email-service/src/jobs/compress-static.js 4 --yes
          fi
          
          # Управление процессами через PM2
          pm2 delete admin-spa-ssr || true
          cd /root/email-service/apps/admin-spa
          pm2 start server.js --name admin-spa-ssr --time
          pm2 save
          
          # Перезапуск nginx
          systemctl restart nginx
        "

    # ----------------------------
    # 9. ПРОВЕРКА РАБОТОСПОСОБНОСТИ
    # ----------------------------
    - name: Проверка деплоя
      run: |
        ssh root@$SSH_HOST "
          # Проверка процессов
          echo '=== Статус процессов PM2 ==='
          pm2 list
          
          # Проверка файлов
          echo '=== Проверка веб-ассетов ==='
          ls -la /var/www/email-service/admin-spa/assets/ | head -5
          
          # Проверка доступности
          echo '=== Проверка работы SSR ==='
          curl --retry 3 --retry-delay 5 -s http://localhost:3344/ || echo 'Проверка SSR не удалась'
          
          # Очистка SSH ключа
          rm -f ~/.ssh/id_rsa
          echo 'Деплой успешно завершен'
        "